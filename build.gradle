buildscript {
    repositories {
        mavenCentral()
    }
}

plugins {
    id 'com.github.spotbugs' version '4.7.1'
    id 'org.asciidoctor.jvm.convert' version '3.1.0'
    id 'jacoco'
}

group 'org.clematis.desktop'
version '2.0.0-SNAPSHOT'

allprojects {

    repositories {
        mavenCentral()
    }

    apply plugin: 'java'
    apply plugin: 'checkstyle'
    apply plugin: 'jacoco'
    apply plugin: 'idea'

    sourceCompatibility = '17'
    targetCompatibility = '17'

    // ------------ JaCoCo test coverage + ascii doctor as a post processor
    ext {
        setProperty('snippetsDir', file("build/generated-snippets"))
    }

    apply from: file("${project.rootDir}/dependencies.gradle")

    // ------------ JaCoCo configuration  ---------
    test {
        outputs.dir snippetsDir
        useJUnitPlatform()
        testLogging.showStandardStreams = true
        finalizedBy jacocoTestReport
        jacoco {
            destinationFile = file("jacoco/jacocoTest.exec")
            classDumpDir = file("jacoco/classpathdumps")
        }
    }

    jacocoTestReport {
        dependsOn test // tests are required to run before generating the report
        reports {
            xml.required = true
            csv.required = false
            html.outputLocation = file('jacoco/html')
            xml.outputLocation = file('jacoco/jacoco.xml')
        }
        allprojects.each {
            sourceSets it.sourceSets.main
        }
        executionData fileTree(project.rootDir.absolutePath).include("jacoco/*.exec")
    }

    asciidoctor {
        inputs.dir snippetsDir
        dependsOn test
    }

    jar {
        //archiveFileName = "${archiveBaseName}.${archiveExtension}"
        manifest {
            attributes(
                "Implementation-Title": project.name,
                "Implementation-Version": archiveVersion
            )
        }
        from {
            configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
        }
        duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    }

// ------------ Spotbugs configuration  ---------
    spotbugsMain {
        reports {
            xml {
                enabled = false
            }
            html {
                enabled = true
                destination = file("$buildDir/reports/spotbugs/main/spotbugs.html")
            }
        }
    }

    spotbugsTest {
        reports {
            xml {
                enabled = false
            }
            html {
                enabled = true
                destination = file("$buildDir/reports/spotbugs/test/spotbugs.html")
            }
        }
    }

// ------------ Checkstyle configuration  ---------
    checkstyle {
        configProperties.configFile = file("${project.rootDir}/config/checkstyle/checkstyle.xml")
        configProperties.checkstyleSuppressionFile = file("${project.rootDir}/config/checkstyle/suppressions.xml")
    }

    tasks.register('checkstyleReport') {
        doLast {
            if (file("${buildDir}/reports/checkstyle/${project.ext.checkType}.xml").exists()) {
                ant.xslt(in: "${buildDir}/reports/checkstyle/${project.ext.checkType}.xml",
                        style: "${project.rootDir}/config/checkstyle/checkstyle.xsl",
                        out: "${buildDir}/reports/checkstyle/checkstyle_${project.ext.checkType}.html")
            }
        }
    }

    tasks.withType(Checkstyle).tap {
        configureEach {
            exclude '**/*Test*'
        }
    }
}
